<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Chess Football Multiplayer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }

        #board {
            display: grid;
            grid-template-columns: repeat(8, 60px);
            grid-template-rows: repeat(8, 60px);
            margin: 20px auto;
        }

        .square {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            user-select: none;
            /* Prevent text selection */
            -webkit-user-select: none;
            /* Safari */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* IE/Edge */
            cursor: default;
            position: relative;
            /* For highlight overlay */
        }

        .square.highlight:after {
            content: '';
            position: absolute;
            height: 60px;
            width: 60px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 0, 0.5);
            /* Highlighted squares */
            pointer-events: none;
            /* Allow clicks to pass through */
        }

        .square.can-move {
            cursor: pointer;
        }

        .light {
            background: #f0d9b5;
        }

        .dark {
            background: #b58863;
        }

        #controls {
            margin: 10px;
        }

        #log {
            border: 1px solid #aaa;
            width: 500px;
            height: 150px;
            overflow-y: auto;
            margin: 10px auto;
            text-align: left;
            padding: 5px;
        }

        #players {
            margin: 10px;
        }

        .selected {
            outline: 2px solid red;
            z-index: 10;
        }
    </style>
</head>

<body>
    <h1>Chess Football Multiplayer</h1>

    <div>
        Server: <input id="serverUrl" value="ws://grahamcatterall.online/chess:8081" size="25">
        Name: <input id="playerName" value="Player">
        Password: <input id="password" type="password" value="">
        <button id="connectBtn">Connect</button>
        <button id="disconnectBtn" disabled>Disconnect</button>
    </div>

    <div id="players"><strong>Players:</strong> <span id="playerList"></span></div>

    <button id="startBtn" disabled>Start Game</button>
    <div id="turn"></div>

    <div id="board" style="margin: 0 auto;"></div>

    <div id="controls">
        <button id="passBtn">Pass</button>
        <button id="shootBtn">Shoot</button>
    </div>

    <div id="log"></div>

    <script>
        const boardEl = document.getElementById('board');
        const logEl = document.getElementById('log');
        const playersEl = document.getElementById('playerList');
        const turnEl = document.getElementById('turn');

        let ws = null;
        let connected = false;
        let playerName = '';
        let gameStarted = false;
        let playerColor = null; // 'white' or 'black' - assigned when game starts

        // Game state
        let board = [];
        let scores = { white: 0, black: 0 };
        let turn = 'white';
        let selected = null;
        let highlights = [];
        let ball = { x: 4, y: 6 }; // starts on e2 (White pawn)
        let passActivated = false;

        function log(msg) {
            logEl.innerHTML += msg + '<br>';
            logEl.scrollTop = logEl.scrollHeight;
        }

        function initBoard() {
            board = Array(8).fill(null).map(() => Array(8).fill(null));
            for (let i = 0; i < 8; i++) {
                board[1][i] = 'bp';
                board[6][i] = 'wp';
            }
            board[0][0] = board[0][7] = 'br';
            board[7][0] = board[7][7] = 'wr';
            board[0][1] = board[0][6] = 'bn';
            board[7][1] = board[7][6] = 'wn';
            board[0][2] = board[0][5] = 'bb';
            board[7][2] = board[7][5] = 'wb';
            board[0][3] = 'bq';
            board[7][3] = 'wq';
            board[0][4] = 'bk';
            board[7][4] = 'wk';
        }

        function pieceSymbol(piece) {
            if (!piece) return '';
            const map = {
                'wp': '♙', 'wr': '♖', 'wn': '♘', 'wb': '♗', 'wq': '♕', 'wk': '♔',
                'bp': '♟', 'br': '♜', 'bn': '♞', 'bb': '♝', 'bq': '♛', 'bk': '♚'
            };
            return map[piece] || '';
        }

        function drawBoard() {
            boardEl.innerHTML = '';
            for (let y = 0; y < 8; y++) {
                for (let x = 0; x < 8; x++) {
                    const square = document.createElement('div');
                    square.className = 'square ' + ((x + y) % 2 === 0 ? 'light' : 'dark');
                    square.dataset.x = x;
                    square.dataset.y = y;

                    let piece = board[y][x];
                    square.textContent = pieceSymbol(piece);

                    // Add pointer cursor for pieces the current player can move
                    if (gameStarted && piece && playerColor && turn === playerColor) {
                        if ((turn === 'white' && piece[0] === 'w') || (turn === 'black' && piece[0] === 'b')) {
                            square.classList.add('can-move');
                        }
                    }

                    if (ball.x === x && ball.y === y) {
                        square.textContent += '⚽';
                    }

                    if (selected && selected.x === x && selected.y === y) {
                        square.classList.add('selected');
                    }

                    if (highlights.some(h => h.x === x && h.y === y)) {
                        square.classList.add('highlight');
                    }

                    square.onclick = () => onSquareClick(x, y);
                    boardEl.appendChild(square);
                }
            }
            turnEl.innerHTML = `Turn: ${turn}, Score W:${scores.white} B:${scores.black}${playerColor ? ` | You are: ${playerColor}` : ''}`;
        }

        function inBounds(x, y) { return x >= 0 && x < 8 && y >= 0 && y < 8; }

        function getMoves(piece, x, y) {
            const moves = [];
            const color = piece[0];
            const type = piece[1];
            const dir = color === 'w' ? -1 : 1;

            function addMove(nx, ny) {
                if (!inBounds(nx, ny)) return;
                if (!board[ny][nx] || board[ny][nx][0] !== color) moves.push({ x: nx, y: ny });
            }

            function slide(dx, dy) {
                let nx = x + dx, ny = y + dy;
                while (inBounds(nx, ny)) {
                    if (!board[ny][nx]) {
                        moves.push({ x: nx, y: ny });
                    } else {
                        if (board[ny][nx][0] !== color) moves.push({ x: nx, y: ny });
                        break;
                    }
                    nx += dx; ny += dy;
                }
            }

            if (type === 'p') {
                if (!board[y + dir]?.[x]) addMove(x, y + dir);
                if ((color === 'w' && y === 6) || (color === 'b' && y === 1)) {
                    if (!board[y + 2 * dir]?.[x] && !board[y + dir]?.[x]) addMove(x, y + 2 * dir);
                }
                for (let dx of [-1, 1]) {
                    if (board[y + dir]?.[x + dx] && board[y + dir][x + dx][0] !== color) addMove(x + dx, y + dir);
                }
            } else if (type === 'r') {
                slide(1, 0); slide(-1, 0); slide(0, 1); slide(0, -1);
            } else if (type === 'b') {
                slide(1, 1); slide(-1, 1); slide(1, -1); slide(-1, -1);
            } else if (type === 'q') {
                slide(1, 0); slide(-1, 0); slide(0, 1); slide(0, -1);
                slide(1, 1); slide(-1, 1); slide(1, -1); slide(-1, -1);
            } else if (type === 'n') {
                for (let [dx, dy] of [[1, 2], [2, 1], [-1, 2], [-2, 1], [1, -2], [2, -1], [-1, -2], [-2, -1]]) {
                    addMove(x + dx, y + dy);
                }
            } else if (type === 'k') {
                for (let dx = -1; dx <= 1; dx++) for (let dy = -1; dy <= 1; dy++) if (dx || dy) addMove(x + dx, y + dy);
            }
            return moves;
        }

        function onSquareClick(x, y) {
            if (!gameStarted) return;

            // Only allow moves if it's the current player's turn
            if (playerColor && turn !== playerColor) {
                return; // Not this player's turn
            }

            if (!selected) {
                if (board[y][x] && ((turn === 'white' && board[y][x][0] === 'w') || (turn === 'black' && board[y][x][0] === 'b'))) {
                    selected = { x, y };
                    highlights = getMoves(board[y][x], x, y);
                    drawBoard();
                }
            } else {
                if (highlights.some(h => h.x === x && h.y === y) && !passActivated) {
                    console.log('Moving piece from', selected, 'to', { x, y }, '- passActivated:', passActivated);
                    let piece = board[selected.y][selected.x];
                    board[y][x] = piece;
                    board[selected.y][selected.x] = null;
                    if (ball.x === selected.x && ball.y === selected.y) ball = { x, y };
                    turn = (turn === 'white' ? 'black' : 'white');
                    sendState('move');
                }
                selected = !passActivated ? null : selected; highlights = [];
                drawBoard();
            }
        }

        function passBall(target) {
            console.log('Attempting to pass ball to', target, 'with selected:', selected);
            if (!selected) return;

            // Only allow pass if it's the current player's turn
            if (playerColor && turn !== playerColor) {
                return; // Not this player's turn
            }
            console.log('Passing ball to', target);

            const sx = selected.x, sy = selected.y;
            const tx = target.x, ty = target.y;
            let dx = Math.sign(tx - sx), dy = Math.sign(ty - sy);
            if (Math.abs(tx - sx) !== Math.abs(ty - sy) && sx !== tx && sy !== ty) return;
            let x = sx + dx, y = sy + dy;
            while (x !== tx || y !== ty) {
                if (board[y][x]) return;
                x += dx; y += dy;
            }
            if (board[ty][tx] && board[ty][tx][0] === board[sy][sx][0]) {
                ball = { x: tx, y: ty };
                turn = (turn === 'white' ? 'black' : 'white');
                sendState('pass');
            }
        }

        function shootBall() {
            if (!selected) return;

            // Only allow shoot if it's the current player's turn
            if (playerColor && turn !== playerColor) {
                return; // Not this player's turn
            }

            const sx = selected.x, sy = selected.y;
            let color = board[sy][sx][0];
            let dir = color === 'w' ? -1 : 1;
            let x = sx, y = sy + dir;
            while (inBounds(x, y)) {
                if (board[y][x]) {
                    if (board[y][x][0] !== color) {
                        ball = { x, y };
                    }
                    break;
                }
                y += dir;
            }
            if (y < 0) scores.white++; if (y > 7) scores.black++;
            turn = (turn === 'white' ? 'black' : 'white');
            sendState('shoot');
        }

        function sendState(type) {
            if (connected && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type, state: { board, scores, turn, ball } }));
            }
        }

        document.getElementById('connectBtn').onclick = () => {
            const url = document.getElementById('serverUrl').value;
            playerName = document.getElementById('playerName').value;
            const password = document.getElementById('password').value;
            ws = new WebSocket(url);
            ws.onopen = () => {
                connected = true;
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                ws.send(JSON.stringify({ type: 'join', name: playerName, password }));
            };
            ws.onmessage = (ev) => {
                const data = JSON.parse(ev.data);
                switch (data.type) {
                    case 'players':
                        playersEl.textContent = data.players.join(', ');
                        document.getElementById('startBtn').disabled = data.players.length < 2;

                        // Assign player colors based on order of joining
                        const playerIndex = data.players.indexOf(playerName);
                        if (playerIndex === 0) {
                            playerColor = 'white';
                        } else if (playerIndex === 1) {
                            playerColor = 'black';
                        }
                        break;
                    case 'started':
                        gameStarted = true;
                        initBoard();
                        ball = { x: 4, y: 6 };
                        scores = { white: 0, black: 0 };
                        turn = 'white';
                        drawBoard();
                        break;
                    case 'state':
                        board = data.state.board;
                        scores = data.state.scores;
                        turn = data.state.turn;
                        ball = data.state.ball;
                        drawBoard();
                        break;
                    case 'log':
                        log(data.message);
                        break;
                    case 'error':
                        alert(data.message);
                        break;
                }
            };
            ws.onclose = () => {
                connected = false;
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
            };
        };

        document.getElementById('disconnectBtn').onclick = () => { if (ws) ws.close(); };
        document.getElementById('startBtn').onclick = () => { if (connected) ws.send(JSON.stringify({ type: 'start' })); };

        document.getElementById('passBtn').onclick = () => {
            if (playerColor && turn !== playerColor) {
                log("It's not your turn!");
                return;
            }
            if (!selected) {
                log("Select a piece to pass the ball.");
                return;
            }
            if (!passActivated) {
                passActivated = true;
                document.getElementById('passBtn').textContent = "Move Mode";
                log("Pass mode activated.");
                // Find all friendly pieces in straight lines from the selected piece
                let sx = selected.x, sy = selected.y;
                let color = board[sy][sx][0];
                let targets = [];
                highlights = [];
                let directions = [
                    [1, 0], [-1, 0], [0, 1], [0, -1],
                    [1, 1], [-1, 1], [1, -1], [-1, -1]
                ];
                for (let [dx, dy] of directions) {
                    let x = sx + dx, y = sy + dy;
                    while (inBounds(x, y)) {
                        if (board[y][x]) {
                            if (board[y][x][0] === color) {
                                targets.push({ x, y });
                                highlights.push({ x, y });
                            }
                            break;
                        }
                        x += dx; y += dy;
                    }
                }
                drawBoard();
                if (targets.length) {
                    log("Click a highlighted piece to pass the ball.");
                    console.log("Valid pass targets:", targets);
                    // Set up a one-time click handler for pass
                    boardEl.onclick = (e) => {
                        const targetEl = e.target;
                        if (targetEl.classList.contains('highlight')) {
                            const tx = parseInt(targetEl.dataset.x);
                            const ty = parseInt(targetEl.dataset.y);
                            passBall({ x: tx, y: ty });
                            highlights = [];
                            drawBoard();
                            boardEl.onclick = null;
                            passActivated = false;
                            document.getElementById('passBtn').textContent = "Pass";
                            log("Pass mode deactivated.");
                        }
                    };
                } else {
                    log("No valid pass targets found!");
                    passActivated = false;
                    document.getElementById('passBtn').textContent = "Pass";
                }
            } else {
                passActivated = false;
                document.getElementById('passBtn').textContent = "Pass";
                highlights = [];
                drawBoard();
                boardEl.onclick = null;
                log("Pass mode deactivated.");
            }
        };
        document.getElementById('shootBtn').onclick = () => {
            if (playerColor && turn !== playerColor) {
                log("It's not your turn!");
                return;
            }
            passActivated = false;
            shootBall();
        };

        initBoard();
        drawBoard();
    </script>
</body>

</html>